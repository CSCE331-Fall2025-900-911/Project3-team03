<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Yi Fang Tea - Cashier</title>
        <link rel="stylesheet" href="/CashierPageCSS.css" />
        <link rel="stylesheet" href="/Accessibility.css" />
    </head>
    <body>
        <!-- dark blue bar and logo -->
        <header class="header-container">
            <nav class="nav-left">
                <a href="/employee">Back to Employee Page</a>
                <a href="/logout">Log Out</a>
            </nav>
            <div class="logo-container">
                <a href="/"><img src="/logo.png" alt="logo" class="logo" /></a>
            </div>
        </header>

        <!-- Cart Notification for successfully adding drink -->
        <div
            id="cart-notification"
            class="cart-notification"
            role="status"
            aria-live="polite"
            hidden
        >
            Successfully Added to Shopping Cart!
        </div>

        <div class="menu-title">
            <h1>Drinks Menu</h1>
        </div>

<div class="cashier-layout">
            <div class="menu-section">
                <!-- All drinks showing name/price -->
                <div class="menu-items">
                    <!-- Drinks seperated by tabs -->
                <div class="menu-tabs">
                    <button class="menu-tab active" data-tab="tea">Tea Series</button>
                    <button class="menu-tab" data-tab="fruit-tea">Fruit Tea Series</button>
                    <button class="menu-tab" data-tab="tea-latte">Tea Latte Series</button>
                    <button class="menu-tab" data-tab="traditional">Traditional Series</button>
                    <button class="menu-tab" data-tab="seasonal">Seasonal Series</button>
                </div>

                <section class="tab-panel active" data-tab="tea">
                    <!-- Category: Tea -->
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="1"
                                data-name="Puchong Green Tea"
                                data-price="5.49"
                            >Puchong Green Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="2"
                                data-name="Lugu Oolong Tea"
                                data-price="5.49"
                            >Lugu Oolong Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="3"
                                data-name="Sun Moon Lake Black Tea"
                                data-price="5.49"
                            >Sun Moon Lake Black Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="4"
                                data-name="Songboling Mountain Tea"
                                data-price="5.49"
                            >Songboling Mountain Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="fruit-tea">
                    <!-- Category: Fruit Tea -->
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="5"
                                data-name="Yi Fang Fruit Tea"
                                data-price="5.49"
                            >Yi Fang Fruit Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="6"
                                data-name="Mango Fruit Tea"
                                data-price="5.49"
                            >Mango Fruit Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="7"
                                data-name="Lemon Green Tea"
                                data-price="5.49"
                            >Lemon Green Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="8"
                                data-name="Passion Fruit Green Tea"
                                data-price="5.99"
                            >Passion Fruit Green Tea
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="9"
                                data-name="Lychee Fruit Tea"
                                data-price="5.99"
                            >Lychee Fruit Te
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="tea-latte">
                    <!-- Category: Tea Latte -->
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="10"
                                data-name="Brown Sugar Pearl Latte"
                                data-price="5.99"
                            >Brown Sugar Pearl Latte
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="11"
                                data-name="Kyoto Uji Matcha Latte"
                                data-price="6.49"
                            >Kyoto Uji Matcha Latte
                            </button>
                            <p class="price">$6.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="12"
                                data-name="Brown Sugar Pearl Matcha Latte"
                                data-price="6.49"
                            >Brown Sugar Pearl Matcha Latte
                            </button>
                            <p class="price">$6.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="13"
                                data-name="Red Bean Matcha Latte"
                                data-price="6.49"
                            >Red Bean Matcha Latte
                            </button>
                            <p class="price">$6.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="14"
                                data-name="Brown Sugar Pearl Coco Latte"
                                data-price="6.49"
                            >Brown Sugar Pearl Coco Latte
                            </button>
                            <p class="price">$6.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="15"
                                data-name="Red Bean Matcha Latte"
                                data-price="6.49"
                            >Red Bean Matcha Latte
                            </button>
                            <p class="price">$6.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="16"
                                data-name="Red Bean Purple Rice Coconut Latte"
                                data-price="5.99"
                            >Red Bean Purple Rice Coconut Latte
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="traditional">
                    <!-- Category: Traditional -->
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="17"
                                data-name="Grass Jelly Milk Tea"
                                data-price="6.49"
                            >Grass Jelly Milk Tea
                            </button>
                            <p class="price">$6.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="18"
                                data-name="Winter Melon Tea"
                                data-price="4.99"
                            >Winter Melon Tea
                            </button>
                            <p class="price">$4.99</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="19"
                                data-name="Grass Tea"
                                data-price="4.99"
                            >Grass Tea
                            </button>
                            <p class="price">$4.99</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="20"
                                data-name="Tradtional Milk Tea"
                                data-price="5.99"
                            >Tradtional Milk Tea
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="seasonal">
                    <!-- Category: Seasonal -->
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="21"
                                data-name="Longan Ginger Tea"
                                data-price="5.99"
                            >Longan Ginger Tea
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="22"
                                data-name="Lemon Green Tea"
                                data-price="5.49"
                            >Lemon Green Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="23"
                                data-name="Ginger Tea"
                                data-price="5.49"
                            >Ginger Tea
                            </button>
                            <p class="price">$5.49</p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="24"
                                data-name="Pearl Ginger Milk Tea"
                                data-price="5.99"
                            >Pearl Ginger Milk Tea
                            </button>
                            <p class="price">$5.99</p>
                        </div>
                    </div>
                </section>
                </div> <!-- End menu-items -->
            </div> <!-- End menu-section -->

            <!-- Sidebar -->
            <aside class="sidebar-section">
                <h2 class="sidebar-title">Current Order</h2>
                <div id="sidebar-cart" class="cart-content">
                    <!-- Cart items will be rendered here -->
                </div>
                <div class="sidebar-footer">
                    <div class="cart-total">
                        <span>Total</span>
                        <span class="cart-total-price">$0.00</span>
                    </div>
                    <a href="/payment" class="checkout-btn">Proceed to Payment</a>
                </div>
            </aside>
        </div> <!-- End cashier-layout -->

        <!-- Toppings Section -->
        <div id="toppings" class="toppings-modal" hidden>
            <div class="toppings-content">
                <div class="toppings-header">
                    <h2 class="toppings-title">Choose your toppings</h2>
                    <button class="toppings-close">
                        ✕
                    </button>
                </div>

                <div class="toppings-section">
                    <h3>Toppings</h3>
                    <div class="topping-grid">
                        <div class="topping">
                            <label> <input type="checkbox" value="pearl" />Pearl (+$0.5)</label>
                        </div>
                        <div class="topping">
                            <label> <input type="checkbox" value="aloe" />Aloe (+$0.5)</label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="lychee-jelly" />Lychee Jelly (+$0.5)
                            </label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="almond-jelly" />Almond Jelly (+$0.5)
                            </label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="custard-pudding" />Custard Pudding
                                (+$0.5)
                            </label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="crystal-boba" />Crystal Boba (+$0.5)
                            </label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="aiyu-jelly" />Aiyu Jelly (+$0.5)
                            </label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="grass-jelly" />Grass Jelly (+$0.5)
                            </label>
                        </div>
                        <div class="topping">
                            <label>
                                <input type="checkbox" value="salty-cream" />Salty Cream (+$0.5)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="drink-attributes">
                    <h3>Drink Attributes</h3>
                    <div class="attribute">
                        <p class="attribute-title"><strong>Select Size:</strong></p>
                        <label><input type="radio" name="size" value="small" />Small</label>
                        <label><input type="radio" name="size" value="medium" checked/>Medium (+$0.5)</label>
                        <label><input type="radio" name="size" value="large" />Large (+$1.5)</label>
                    </div>
                    <div class="attribute">
                        <p class="attribute-title"><strong>Select Temp:</strong></p>
                        <label><input type="radio" name="temp" value="hot" checked/>Hot</label>
                        <label><input type="radio" name="temp" value="cold" />Cold</label>
                    </div>
                    <div class="attribute">
                        <p class="attribute-title"><strong>Sugar Level:</strong></p>
                        <label><input type="radio" name="sugar" value="0" />0%</label>
                        <label><input type="radio" name="sugar" value="25" />25%</label>
                        <label><input type="radio" name="sugar" value="50" />50%</label>
                        <label><input type="radio" name="sugar" value="75" />75%</label>
                        <label><input type="radio" name="sugar" value="100" checked/>100%</label>
                    </div>
                    <div class="attribute">
                        <p class="attribute-title"><strong>Ice Level:</strong></p>
                        <label><input type="radio" name="ice" value="0" />0%</label>
                        <label><input type="radio" name="ice" value="25" />25%</label>
                        <label><input type="radio" name="ice" value="50" />50%</label>
                        <label><input type="radio" name="ice" value="75" />75%</label>
                        <label><input type="radio" name="ice" value="100" checked/>100%</label>
                    </div>
                    <div class="attribute">
                        <p class="attribute-title"><strong>Milk type:</strong></p>
                        <label><input type="radio" name="milk" value="soy" />Soy (+$1.0)</label>
                        <label><input type="radio" name="milk" value="oat" />Oat (+$1.0)</label>
                        <label><input type="radio" name="milk" value="original" checked/>Original</label>
                    </div>
                </div>

                <div class="toppings-footer">
                    <div class="quantity-control">
                        <button
                            type="button"
                            class="qty-decrease"
                            aria-label="Decrease quantity"
                        >−</button>
                        <span class="qty-value" aria-live="polite">1</span>
                        <button
                            type="button"
                            class="qty-increase"
                            aria-label="Increase quantity"
                        >+</button>
                    </div>

                    <button class="add-to-cart">Add to Cart</button>
                </div>
            </div>
        </div>


        <!-- dark blue bar and logo -->
        <footer class="header-container">
            <div class="logo-container">
                <a href="/"><img src="/logo.png" alt="Yi Fang Logo" class="logo" /></a>
            </div>
        </footer>

        <%- include("accessibilityFeaturesPage") %>
        <script type="module" src="/js/ADHDFocus.js"></script>
        <script src="/js/translation.js"></script>
        <script src="/js/textToSpeech.js"></script>

        <script type="module">
            import { addToCart, getCart, saveCart, renderCartInto, computePrice, dollars } from '/js/cart.js';

            let pendingDrink = null;
            let editCartIndex = null;

            const toppingsModal = document.getElementById('toppings');
            const toppingsCloseBtn = toppingsModal.querySelector('.toppings-close');
            const cartContainer = document.getElementById('sidebar-cart');
            const totalNode = document.querySelector('.cart-total-price');

            let quantity = 1; // user can set the amount of drinks to add to cart

            const qtyValue = toppingsModal.querySelector('.qty-value');      
            const qtyDecBtn = toppingsModal.querySelector('.qty-decrease'); 
            const qtyIncBtn = toppingsModal.querySelector('.qty-increase'); 
            const cartNotification = document.getElementById('cart-notification');

            // --- Sidebar Logic ---
            function updateSidebar() {
                const { total } = renderCartInto(cartContainer);
                totalNode.textContent = `$${dollars(total)}`;
            }

            // Initial render
            updateSidebar();

            // Handle Sidebar Clicks (Edit/Remove)
            cartContainer.addEventListener('click', (e) => {
                // Remove
                if (e.target.closest('.remove-line')) {
                    // renderCartInto handles the removal logic internally if we didn't override it,
                    // BUT renderCartInto in cart.js attaches its own event listener for remove-line?
                    // Let's check cart.js.
                    // cart.js: removeBtn.addEventListener('click', ...) -> calls renderCartInto.
                    // So we just need to update OUR total.
                    // Actually, cart.js's renderCartInto updates the total node if found by selector .cart-total-price.
                    // So it might just work!
                    // Let's double check if we need to do anything here.
                    // The cart.js implementation of renderCartInto attaches a click listener to remove button.
                    // It modifies the cart, saves it, re-renders (into the same container), and updates .cart-total-price.
                    // Since we use the same class names (.cart-total-price), it should work out of the box!
                    return; 
                }

                // Edit
                const editBtn = e.target.closest('.edit-line');
                if (editBtn) {
                    const line = editBtn.closest('.cart-line');
                    const index = Number(line.dataset.index);
                    editItem(index);
                }
            });

            function editItem(index) {
                const cart = getCart();
                const item = cart[index];
                if (!item) return;

                editCartIndex = index;
                pendingDrink = {
                    drinkId: item.drinkId,
                    name: item.name,
                    basePrice: item.basePrice,
                    imgSrc: item.imgSrc || `/drinksImages/${item.drinkId}.png`,
                };

                const scope = document.getElementById('toppings');

                // Prefill toppings
                const currentToppings = item.toppings || [];
                scope.querySelectorAll('.topping input[type="checkbox"]').forEach((cb) => {
                    cb.checked = currentToppings.includes(cb.value);
                });

                scope.querySelectorAll('input[type="radio"]').forEach((r) => {
                    r.checked = false;
                });

                const setRadio = (name, value) => {
                    if (value == null) return;
                    const input = scope.querySelector(
                        `input[name="${name}"][value="${value}"]`
                    );
                    if (input) input.checked = true;
                };

                setRadio('size', item.size);
                setRadio('temp', item.temp);
                setRadio('sugar', item.sugar);
                setRadio('ice', item.ice);
                setRadio('milk', item.milk);

                setQuantity(1); // Default to 1 when editing, or maybe we should support quantity in cart item? 
                                // Current cart item doesn't seem to store quantity (it stores individual items). 
                                // So we just edit one item.

                openToppings();
            }

            function showCartNotification(message) {
                if (!cartNotification) return;
                cartNotification.textContent = message;
                cartNotification.hidden = false;
                cartNotification.classList.add('show');

                setTimeout(() => {
                    cartNotification.classList.remove('show');
                    setTimeout(() => {
                        cartNotification.hidden = true;
                    }, 250);
                }, 4000);
            }


            function setQuantity(newQty) {                                   
                quantity = Math.max(1, newQty);
                if (qtyValue) {
                    qtyValue.textContent = String(quantity);
                }
            }

            function openToppings() {
                setQuantity(1);
                toppingsModal.hidden = false;
                toppingsModal.classList.add('open');
            }

            function closeToppings() {
                toppingsModal.classList.remove('open');
                toppingsModal.hidden = true;
            }

            if (toppingsCloseBtn) {
                toppingsCloseBtn.addEventListener('click', () => {
                    closeToppings();
                });
            }

            if (qtyDecBtn) {
                qtyDecBtn.addEventListener('click', () => {
                    setQuantity(quantity - 1); 
                });
            }

            if (qtyIncBtn) {
                qtyIncBtn.addEventListener('click', () => {
                    setQuantity(quantity + 1);
                });
            }

            // If we came here from the payment page to edit an existing drink:
            const storedEditIndex = sessionStorage.getItem('editIndex');
            if (storedEditIndex !== null) {
                editItem(Number(storedEditIndex));
                sessionStorage.removeItem('editIndex');
            }

            // Lets a cashier click a drink, pick attributes, and add that configured drink to the cart stored in localStorage 
            document.querySelectorAll('button[drink-id]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    pendingDrink = {
                        drinkId: Number(btn.getAttribute('drink-id')),
                        name: btn.dataset.name,
                        basePrice: Number(btn.dataset.price),
                        imgSrc:
                            btn.querySelector('img')?.getAttribute('src') ||
                            `/drinksImages/${btn.getAttribute('drink-id')}.png`,
                    };
                    const scope = document.getElementById('toppings');
                    scope
                        .querySelectorAll('input[type="checkbox"]')
                        .forEach((i) => (i.checked = false));
                    scope
                        .querySelectorAll('input[type="radio"]')
                        .forEach((i) => (i.checked = i.defaultChecked));
                    scope
                        .querySelectorAll('.attribute.invalid')
                        .forEach((el) => el.classList.remove('invalid'));

                    openToppings();
                });
            });

            function isPicked(scope, name) {
                return !!scope.querySelector(`input[name="${name}"]:checked`);
            }
            function markInvalid(scope, name, on) {
                const block = scope.querySelector(`input[name="${name}"]`)?.closest('.attribute');
                if (block) block.classList.toggle('invalid', !!on);
            }

            document.querySelectorAll('#toppings .attribute input[type="radio"]').forEach((r) => {
                r.addEventListener('change', () => {
                    const block = r.closest('.attribute');
                    if (block) block.classList.remove('invalid');
                });
            });

            document.querySelector('.add-to-cart').addEventListener('click', () => {
                if (!pendingDrink) return;

                const scope = document.getElementById('toppings');

                const required = ['size', 'temp', 'sugar', 'ice', 'milk'];
                let ok = true;
                required.forEach((name) => {
                    const has = isPicked(scope, name);
                    markInvalid(scope, name, !has);
                    if (!has) ok = false;
                });

                if (!ok) {
                    alert('Fill out all required items before adding to order');
                    const firstMissing = scope.querySelector('.attribute.invalid');
                    if (firstMissing)
                        firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                const pick = (name) => scope.querySelector(`input[name="${name}"]:checked`)?.value;
                const toppings = Array.from(
                    scope.querySelectorAll('.topping input[type="checkbox"]:checked')
                ).map((cb) => cb.value);

                const item = {
                    drinkId: pendingDrink.drinkId,
                    name: pendingDrink.name,
                    basePrice: pendingDrink.basePrice,
                    size: pick('size'),
                    temp: pick('temp'),
                    sugar: pick('sugar'),
                    ice: pick('ice'),
                    milk: pick('milk'),
                    toppings,
                    imgSrc: pendingDrink.imgSrc,
                };

                if (editCartIndex !== null) {
                    // Edit existing drink, remove the old entry, then add the new one 
                    const cart = getCart();
                    if (editCartIndex >= 0 && editCartIndex < cart.length) {
                        cart.splice(editCartIndex, 1);      
                        saveCart(cart);
                    }

                    const qtyToAdd = quantity || 1;
                    for (let i = 0; i < qtyToAdd; i++) {
                        addToCart(item);
                    }

                    editCartIndex = null; 
                } else {
                    // adding new drink
                    const qtyToAdd = quantity || 1;
                    for (let i = 0; i < qtyToAdd; i++) {
                        addToCart(item);
                    }
                }

                const btn = document.querySelector('.add-to-cart');
                const orig = btn.textContent;
                btn.textContent = 'Added!';
                setTimeout(() => {
                    btn.textContent = orig;
                }, 800);

                showCartNotification('Successfully added to shopping cart');
                updateSidebar(); // Refresh sidebar
                closeToppings();
            });

            // Tab switching logic
            const tabButtons = document.querySelectorAll('.menu-tab');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const target = btn.dataset.tab;

                    tabButtons.forEach((b) => b.classList.remove('active'));
                    btn.classList.add('active');

                    tabPanels.forEach((panel) => {
                        panel.classList.toggle('active', panel.dataset.tab === target);
                    });
                });
            });
        </script>
    </body>
</html>
