<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Yi Fang Tea - Cashier</title>
        <link rel="stylesheet" href="/CustomerPage.css" />
        <link rel="stylesheet" href="/Accessibility.css" />
    </head>
    <body>
        <!-- dark blue bar and logo -->
        <header class="header-container">
            <nav class="nav-left">
                <a href="/customer">Back to Home Page</a>
            </nav>
            <div class="logo-container">
                <a href="/customer"><img src="/logo.png" alt="logo" class="logo" /></a>
            </div>
        </header>

        <main>
            <!-- add header remark for accessibility -->
            <h1 class="visually-hidden">Customer Page</h1>

            <!-- Cart Notification for successfully adding drink -->
            <div
                id="cart-notification"
                class="cart-notification"
                role="status"
                aria-live="polite"
                hidden
            >
                Successfully Added to Shopping Cart!
            </div>

            <div id="weather-box">
                <div class="weather-info">
                    <p id="weather-location">Loading weather...</p>
                    <p id="weather-temp"></p>
                </div>
                <div id="weather-icon-container"></div>
            </div>

            <div class="menu-title">
                <h1>Drinks Menu</h1>
                <p>Select drinks below and add them to the order.</p>
                <a href="/payment" class="proceed-button">Proceed to Payment</a>
            </div>

            <!-- All drinks showing name/price -->
            <div class="menu-items">
                <!-- Drinks seperated by tabs -->
                <div class="menu-tabs">
                    <button class="menu-tab active" data-tab="tea">Tea Series</button>
                    <button class="menu-tab" data-tab="fruit-tea">Fruit Tea Series</button>
                    <button class="menu-tab" data-tab="tea-latte">Tea Latte Series</button>
                    <button class="menu-tab" data-tab="traditional">Traditional Series</button>
                    <button class="menu-tab" data-tab="seasonal">Seasonal Series</button>
                </div>

                <section class="tab-panel active" data-tab="tea">
                    <!-- Category: Tea -->
                    <h2>Tea Series</h2>
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="1"
                                data-name="Puchong Green Tea"
                                data-price="5.49"
                            >
                                <img src="/drinksImages/1.png" alt="Puchong Green Tea" class="drink" />
                            </button>
                            <p class="drink-name">Puchong Green Tea</p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="2"
                                data-name="Lugu Oolong Tea"
                                data-price="5.49"
                            >
                                <img src="/drinksImages/2.png" alt="Lugu Oolong Tea" class="drink" />
                            </button>
                            <p class="drink-name">Lugu Oolong Tea </p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="3"
                                data-name="Sun Moon Lake Black Tea"
                                data-price="5.49"
                            >
                                <img
                                    src="/drinksImages/3.png"
                                    alt="Sun Moon Lake Black Tea"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Sun Moon Lake Black Tea</p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="4"
                                data-name="Songboling Mountain Tea"
                                data-price="5.49"
                            >
                                <img
                                    src="/drinksImages/4.png"
                                    alt="Songboling Mountain Tea"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Songboling Mountain Tea</p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="fruit-tea">
                    <!-- Category: Fruit Tea -->
                    <h2>Fruit Tea Series</h2>
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="5"
                                data-name="Yi Fang Fruit Tea"
                                data-price="5.49"
                            >
                                <img src="/drinksImages/5.png" alt="Yi Fang Fruit Tea" class="drink" />
                            </button>
                            <p class="drink-name">Yi Fang Fruit Tea</p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="6"
                                data-name="Mango Fruit Tea"
                                data-price="5.49"
                            >
                                <img src="/drinksImages/6.png" alt="Mango Fruit Tea" class="drink" />
                            </button>
                            <p class="drink-name">Mango Fruit Tea </p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="7"
                                data-name="Lemon Green Tea"
                                data-price="5.49"
                            >
                                <img src="/drinksImages/7.png" alt="Lemon Green Tea" class="drink" />
                            </button>
                            <p class="drink-name">Lemon Green Tea </p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="8"
                                data-name="Passion Fruit Green Tea"
                                data-price="5.99"
                            >
                                <img
                                    src="/drinksImages/8.png"
                                    alt="Passion Fruit Green Tea"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Passion Fruit Green Tea </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="9"
                                data-name="Lychee Fruit Tea"
                                data-price="5.99"
                            >
                                <img src="/drinksImages/9.png" alt="Lychee Fruit Tea" class="drink" />
                            </button>
                            <p class="drink-name">Lychee Fruit Tea </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="tea-latte">
                    <!-- Category: Tea Latte -->
                    <h2>Tea Latte Series</h2>
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="10"
                                data-name="Brown Sugar Pearl Latte"
                                data-price="5.99"
                            >
                                <img
                                    src="/drinksImages/10.png"
                                    alt="Brown Sugar Pearl Latte"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Brown Sugar Pearl Latte </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="11"
                                data-name="Kyoto Uji Matcha Latte"
                                data-price="6.49"
                            >
                                <img
                                    src="/drinksImages/11.png"
                                    alt="Kyoto Uji Matcha Latte"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Kyoto Uji Matcha Latte </p>
                            <p class="price">$6.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="12"
                                data-name="Brown Sugar Pearl Matcha Latte"
                                data-price="6.49"
                            >
                                <img
                                    src="/drinksImages/12.png"
                                    alt="Brown Sugar Pearl Matcha Latte"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Brown Sugar Pearl Matcha Latte </p>
                            <p class="price">$6.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="13"
                                data-name="Red Bean Matcha Latte"
                                data-price="6.49"
                            >
                                <img
                                    src="/drinksImages/13.png"
                                    alt="Red Bean Matcha Latte"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Red Bean Matcha Latte </p>
                            <p class="price">$6.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="14"
                                data-name="Brown Sugar Pearl Coco Latte"
                                data-price="6.49"
                            >
                                <img
                                    src="/drinksImages/14.png"
                                    alt="Brown Sugar Pearl Coco Latte"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Brown Sugar Pearl Coco Latte </p>
                            <p class="price">$6.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="16"
                                data-name="Red Bean Purple Rice Coconut Latte"
                                data-price="5.99"
                            >
                                <img
                                    src="/drinksImages/16.png"
                                    alt="Red Bean Purple Rice Coconut Latte"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Red Bean Purple Rice Coconut Latte </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="traditional">
                    <!-- Category: Traditional -->
                    <h2>Traditional Series</h2>
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="17"
                                data-name="Grass Jelly Milk Tea"
                                data-price="6.49"
                            >
                                <img
                                    src="/drinksImages/17.png"
                                    alt="Grass Jelly Milk Tea"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Grass Jelly Milk Tea </p>
                            <p class="price">$6.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="18"
                                data-name="Winter Melon Tea"
                                data-price="4.99"
                            >
                                <img src="/drinksImages/18.png" alt="Winter Melon Tea" class="drink" />
                            </button>
                            <p class="drink-name">Winter Melon Tea </p>
                            <p class="price">$4.99</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button type="button" drink-id="19" data-name="Grass Tea" data-price="4.99">
                                <img src="/drinksImages/19.png" alt="Grass Tea" class="drink" />
                            </button>
                            <p class="drink-name">Grass Tea </p>
                            <p class="price">$4.99</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="20"
                                data-name="Traditional Milk Tea"
                                data-price="5.99"
                            >
                                <img
                                    src="/drinksImages/20.png"
                                    alt="Traditional Milk Tea"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Traditional Milk Tea </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab="seasonal">
                    <!-- Category: Seasonal -->
                    <h2>Seasonal Series</h2>
                    <div class="drink-items">
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="21"
                                data-name="Longan Ginger Tea"
                                data-price="5.99"
                            >
                                <img src="/drinksImages/21.png" alt="Longan Ginger Tea" class="drink" />
                            </button>
                            <p class="drink-name">Longan Ginger Tea </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="23"
                                data-name="Ginger Tea"
                                data-price="5.49"
                            >
                                <img src="/drinksImages/23.png" alt="Ginger Tea" class="drink" />
                            </button>
                            <p class="drink-name">Ginger Tea </p>
                            <p class="price">$5.49</p>
                            <p class="description"></p>
                        </div>
                        <div class="drink-item">
                            <button
                                type="button"
                                drink-id="24"
                                data-name="Pearl Ginger Milk Tea"
                                data-price="5.99"
                            >
                                <img
                                    src="/drinksImages/24.png"
                                    alt="Pearl Ginger Milk Tea"
                                    class="drink"
                                />
                            </button>
                            <p class="drink-name">Pearl Ginger Milk Tea </p>
                            <p class="price">$5.99</p>
                            <p class="description"></p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Toppings Section -->
            <div id="toppings" class="toppings-modal" hidden>
                <div class="toppings-content">
                    <div class="toppings-header">
                        <h2 class="toppings-title">Choose your toppings</h2>
                        <button class="toppings-close">✕</button>
                    </div>

                    <div class="toppings-section">
                        <h3>Toppings</h3>
                        <div class="topping-grid">
                            <div class="topping">
                                <label> <input type="checkbox" value="pearl" />Pearl (+$0.5)</label>
                            </div>
                            <div class="topping">
                                <label> <input type="checkbox" value="aloe" />Aloe (+$0.5)</label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="lychee-jelly" />Lychee Jelly (+$0.5)
                                </label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="almond-jelly" />Almond Jelly (+$0.5)
                                </label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="custard-pudding" />Custard Pudding
                                    (+$0.5)
                                </label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="crystal-boba" />Crystal Boba (+$0.5)
                                </label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="aiyu-jelly" />Aiyu Jelly (+$0.5)
                                </label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="grass-jelly" />Grass Jelly (+$0.5)
                                </label>
                            </div>
                            <div class="topping">
                                <label>
                                    <input type="checkbox" value="salty-cream" />Salty Cream (+$0.5)
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="drink-attributes">
                        <h3>Drink Attributes</h3>
                        <div class="attribute">
                            <p class="attribute-title"><strong>Select Size:</strong></p>
                            <label><input type="radio" name="size" value="small" />Small</label>
                            <label
                                ><input type="radio" name="size" value="medium" />Medium
                                (+$0.5)</label
                            >
                            <label><input type="radio" name="size" value="large" />Large (+$1.5)</label>
                        </div>
                        <div class="attribute">
                            <p class="attribute-title"><strong>Select Temp:</strong></p>
                            <label><input type="radio" name="temp" value="hot" />Hot</label>
                            <label><input type="radio" name="temp" value="cold" />Cold</label>
                        </div>
                        <div class="attribute">
                            <p class="attribute-title"><strong>Sugar Level:</strong></p>
                            <label><input type="radio" name="sugar" value="0" />0%</label>
                            <label><input type="radio" name="sugar" value="25" />25%</label>
                            <label><input type="radio" name="sugar" value="50" />50%</label>
                            <label><input type="radio" name="sugar" value="75" />75%</label>
                            <label><input type="radio" name="sugar" value="100" />100%</label>
                        </div>
                        <div class="attribute">
                            <p class="attribute-title"><strong>Ice Level:</strong></p>
                            <label><input type="radio" name="ice" value="0" />0%</label>
                            <label><input type="radio" name="ice" value="25" />25%</label>
                            <label><input type="radio" name="ice" value="50" />50%</label>
                            <label><input type="radio" name="ice" value="75" />75%</label>
                            <label><input type="radio" name="ice" value="100" />100%</label>
                        </div>
                        <div class="attribute">
                            <p class="attribute-title"><strong>Milk type:</strong></p>
                            <label><input type="radio" name="milk" value="soy" />Soy (+$1.0)</label>
                            <label><input type="radio" name="milk" value="oat" />Oat (+$1.0)</label>
                            <label
                                ><input
                                    type="radio"
                                    name="milk"
                                    value="original"
                                />Original</label
                            >
                        </div>
                    </div>

                    <div class="toppings-footer">
                        <div class="quantity-control">
                            <button
                                type="button"
                                class="qty-decrease"
                                aria-label="Decrease quantity"
                            >−</button>
                            <span class="qty-value" aria-live="polite">1</span>
                            <button
                                type="button"
                                class="qty-increase"
                                aria-label="Increase quantity"
                            >+</button>
                        </div>

                        <button class="add-to-cart">Add to Cart</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- dark blue bar and logo -->
        <footer class="header-container">
            <div class="logo-container">
                <a href="/customer"><img src="/logo.png" alt="Yi Fang Logo" class="logo" /></a>
            </div>
        </footer>

        <%- include("accessibilityFeaturesPage") %>
        <script type="module" src="/js/ADHDFocus.js"></script>
        <script src="/js/translation.js"></script>
        <script src="/js/textToSpeech.js"></script>

        <script type="module">
            import { addToCart, getCart, saveCart } from '/js/cart.js';

            try {
                const res = await fetch('/api/wiki');
                if (res.ok) {
                    const drinkToDesc = await res.json();
                    for (const [drink, desc] of Object.entries(drinkToDesc)) {
                        const drinkItem = document.querySelector(`[data-name="${drink}"]`);
                        if (drinkItem) {
                            const descP = drinkItem.parentElement.querySelector('.description');
                            if (descP) {
                                descP.textContent = desc;
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('Wiki descriptions could not be loaded:', e);
            }

            let pendingDrink = null;
            let editCartIndex = null;

            const toppingsModal = document.getElementById('toppings');
            const toppingsCloseBtn = toppingsModal.querySelector('.toppings-close');

            let quantity = 1; // user can set the amount of drinks to add to cart

            const qtyValue = toppingsModal.querySelector('.qty-value');      
            const qtyDecBtn = toppingsModal.querySelector('.qty-decrease'); 
            const qtyIncBtn = toppingsModal.querySelector('.qty-increase'); 
            const cartNotification = document.getElementById('cart-notification');

            function showCartNotification(message) {
                if (!cartNotification) return;
                cartNotification.textContent = message;
                cartNotification.hidden = false;
                cartNotification.classList.add('show');

                setTimeout(() => {
                    cartNotification.classList.remove('show');
                    setTimeout(() => {
                        cartNotification.hidden = true;
                    }, 250);
                }, 4000);
            }


            function setQuantity(newQty) {                                   
                quantity = Math.max(1, newQty);
                if (qtyValue) {
                    qtyValue.textContent = String(quantity);
                }
            }

            function openToppings() {
                setQuantity(1);
                toppingsModal.hidden = false;
                toppingsModal.classList.add('open');
            }

            function closeToppings() {
                toppingsModal.classList.remove('open');
                toppingsModal.hidden = true;
            }

            if (toppingsCloseBtn) {
                toppingsCloseBtn.addEventListener('click', () => {
                    closeToppings();
                });
            }

            if (qtyDecBtn) {
                qtyDecBtn.addEventListener('click', () => {
                    setQuantity(quantity - 1); 
                });
            }

            if (qtyIncBtn) {
                qtyIncBtn.addEventListener('click', () => {
                    setQuantity(quantity + 1);
                });
            }

            // If we came here from the payment page to edit an existing drink:
            const storedEditIndex = sessionStorage.getItem('editIndex');
            if (storedEditIndex !== null) {
                editCartIndex = Number(storedEditIndex);
                sessionStorage.removeItem('editIndex');   

                const cart = getCart();
                const item = cart[editCartIndex];

                if (item) {
                    pendingDrink = {
                        drinkId: item.drinkId,
                        name: item.name,
                        basePrice: item.basePrice,
                        imgSrc: item.imgSrc || `/drinksImages/${item.drinkId}.png`,
                    };

                    const scope = document.getElementById('toppings');

                    // Prefill toppings checkboxes
                    const currentToppings = item.toppings || [];
                    scope.querySelectorAll('.topping input[type="checkbox"]').forEach((cb) => {
                        cb.checked = currentToppings.includes(cb.value);
                    });

                    scope.querySelectorAll('input[type="radio"]').forEach((r) => {
                        r.checked = false;
                    });

                    const setRadio = (name, value) => {
                        if (value == null) return;
                        const input = scope.querySelector(
                            `input[name="${name}"][value="${value}"]`
                        );
                        if (input) input.checked = true;
                    };

                    setRadio('size', item.size);
                    setRadio('temp', item.temp);
                    setRadio('sugar', item.sugar);
                    setRadio('ice', item.ice);
                    setRadio('milk', item.milk);

                    setQuantity(1);

                    openToppings();
                } else {
                    // index invalid, cancel edit mode
                    editCartIndex = null;
                }
            }

            // Tab switching
            const tabButtons = document.querySelectorAll('.menu-tab');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const target = btn.dataset.tab;

                    tabButtons.forEach((b) => b.classList.remove('active'));
                    btn.classList.add('active');

                    tabPanels.forEach((panel) => {
                        panel.classList.toggle('active', panel.dataset.tab === target);
                    });
                });
            });

            // Lets a cashier click a drink, pick attributes, and add that configured drink to the cart stored in localStorage
            document.querySelectorAll('button[drink-id]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    pendingDrink = {
                        drinkId: Number(btn.getAttribute('drink-id')),
                        name: btn.dataset.name,
                        basePrice: Number(btn.dataset.price),
                        imgSrc:
                            btn.querySelector('img')?.getAttribute('src') ||
                            `/drinksImages/${btn.getAttribute('drink-id')}.png`,
                    };
                    const scope = document.getElementById('toppings');
                    scope
                        .querySelectorAll('input[type="checkbox"]')
                        .forEach((i) => (i.checked = false));
                    scope
                        .querySelectorAll('input[type="radio"]')
                        .forEach((i) => (i.checked = false));
                    scope
                        .querySelectorAll('.attribute.invalid')
                        .forEach((el) => el.classList.remove('invalid'));

                    openToppings();
                });
            });

            function isPicked(scope, name) {
                return !!scope.querySelector(`input[name="${name}"]:checked`);
            }
            function markInvalid(scope, name, on) {
                const block = scope.querySelector(`input[name="${name}"]`)?.closest('.attribute');
                if (block) block.classList.toggle('invalid', !!on);
            }

            document.querySelectorAll('#toppings .attribute input[type="radio"]').forEach((r) => {
                r.addEventListener('change', () => {
                    const block = r.closest('.attribute');
                    if (block) block.classList.remove('invalid');
                });
            });

            document.querySelector('.add-to-cart').addEventListener('click', () => {
                if (!pendingDrink) return;

                const scope = document.getElementById('toppings');

                const required = ['size', 'temp', 'sugar', 'ice', 'milk'];
                let ok = true;
                required.forEach((name) => {
                    const has = isPicked(scope, name);
                    markInvalid(scope, name, !has);
                    if (!has) ok = false;
                });

                if (!ok) {
                    alert('Fill out all required items before adding to order');
                    const firstMissing = scope.querySelector('.attribute.invalid');
                    if (firstMissing)
                        firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                const pick = (name) => scope.querySelector(`input[name="${name}"]:checked`)?.value;
                const toppings = Array.from(
                    scope.querySelectorAll('.topping input[type="checkbox"]:checked')
                ).map((cb) => cb.value);

                const item = {
                    drinkId: pendingDrink.drinkId,
                    name: pendingDrink.name,
                    basePrice: pendingDrink.basePrice,
                    size: pick('size'),
                    temp: pick('temp'),
                    sugar: pick('sugar'),
                    ice: pick('ice'),
                    milk: pick('milk'),
                    toppings,
                    imgSrc: pendingDrink.imgSrc,
                };

                if (editCartIndex !== null) {
                    // Edit existing drink, remove the old entry, then add the new one 
                    const cart = getCart();
                    if (editCartIndex >= 0 && editCartIndex < cart.length) {
                        cart.splice(editCartIndex, 1);      
                        saveCart(cart);
                    }

                    const qtyToAdd = quantity || 1;
                    for (let i = 0; i < qtyToAdd; i++) {
                        addToCart(item);
                    }

                    editCartIndex = null; 
                } else {
                    // adding new drink
                    const qtyToAdd = quantity || 1;
                    for (let i = 0; i < qtyToAdd; i++) {
                        addToCart(item);
                    }
                }

                const btn = document.querySelector('.add-to-cart');
                const orig = btn.textContent;
                btn.textContent = 'Added!';
                setTimeout(() => {
                    btn.textContent = orig;
                }, 800);

                
                showCartNotification('Successfully added to shopping cart');
                closeToppings();
            });

            // Weather Widget
            async function loadWeather() {
                const lat = 30.628;
                const lon = -96.334;

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=fahrenheit`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();

                    const temp = data.current_weather.temperature;
                    const code = data.current_weather.weathercode;
                    const isDay = data.current_weather.is_day; // 1 for day, 0 for night

                    let gifName = 'sun.gif'; // default

                    // Mapping logic
                    if (isDay === 0 && (code === 0 || code === 1 || code === 2 || code === 3)) {
                         gifName = 'night.gif';
                    } else {
                        // Rain: Drizzle (51-57), Rain (61-67), Rain Showers (80-82)
                        if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) {
                            gifName = 'rain.gif';
                        // Snow: Snow Fall (71-77), Snow Showers (85-86)
                        } else if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) {
                            gifName = 'snow.gif';
                        // Thunderstorm (95-99)
                        } else if (code >= 95 && code <= 99) {
                            gifName = 'storm.gif';
                        // Clear (0, 1)
                        } else if (code === 0 || code === 1) {
                            gifName = 'sun.gif';
                        // Partly Cloudy (2)
                        } else if (code === 2) {
                            gifName = 'clouds.gif';
                        // Overcast (3), Fog (45, 48)
                        } else if (code === 3 || code === 45 || code === 48) {
                            gifName = 'cloudy.gif';
                        }
                    }

                    document.getElementById('weather-location').textContent = 'College Station';
                    document.getElementById('weather-temp').textContent = `${temp}°F`;
                    
                    // Replace text with GIF
                    const iconContainer = document.getElementById('weather-icon-container');
                    iconContainer.innerHTML = `<img src="/weatherGifs/${gifName}" alt="Weather Animation" class="weather-gif" />`;
                    
                } catch (err) {
                    console.error(err);
                    document.getElementById('weather-location').textContent = 'Weather unavailable';
                    document.getElementById('weather-temp').textContent = '';
                    document.getElementById('weather-icon-container').innerHTML = '';
                }
            }

            loadWeather();
        </script>
    </body>
</html>
